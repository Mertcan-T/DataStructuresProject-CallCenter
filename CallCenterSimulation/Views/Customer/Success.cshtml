@{
    ViewBag.Title = "Talep Başarılı";
    var ad = TempData["Ad"]?.ToString();
}

<h2>Talebiniz başarıyla alındı.</h2>
<p id="sira" class="mb-3">Sıra numaranız hesaplanıyor...</p>

<div id="yanitAlani" class="alert alert-info d-none mt-3"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const kullaniciAd = "@ad";

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/callCenterHub")
            .withAutomaticReconnect()
            .build();

        async function getQueuePosition() {
            if (!kullaniciAd) return;
            try {
                const response = await fetch('/api/queue/position?name=' + encodeURIComponent(kullaniciAd));
                if (response.ok) {
                    const result = await response.text();
                    document.getElementById("sira").innerText = "Sıra numaranız: " + result;
                } else {
                    document.getElementById("sira").innerText = "Sıra alınamadı.";
                }
            } catch (err) {
                console.error(err);
                document.getElementById("sira").innerText = "Sıra alınamadı.";
            }
        }

        connection.on("ReceiveResponse", function (ad, mesaj) {
            if (ad === kullaniciAd) {
                const alan = document.getElementById("yanitAlani");
                alan.classList.remove("d-none");
                alan.innerHTML = `<strong>Temsilci Yanıtı:</strong> ${mesaj}`;

                // Ek bilgi göstermek için içerik kontrolü
                if (mesaj.toLowerCase().includes("alındı") || mesaj.toLowerCase().includes("tamamlandı")) {
                    setTimeout(() => {
                        alan.innerHTML += "<br><strong>Lütfen memnuniyet formunu doldurun.</strong>";
                    }, 2000);
                }
            }
        });

        connection.on("UpdateQueue", () => getQueuePosition());

        connection.start().then(() => getQueuePosition());
    </script>
}
